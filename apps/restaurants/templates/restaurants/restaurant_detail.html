<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>{{ restaurant.name }} ì‹ë‹¹ ì •ë³´</title>
</head>
<body>
<hr>
<h2>{{ restaurant.name }}</h2>

<hr>
<div class="container mt-4">
    <h2>ë©”ë‰´</h2>
    <div class="menu-list">

        {% comment %}
            ì²« ë²ˆì§¸ ë£¨í”„: ë·°ì—ì„œ ì „ë‹¬ë°›ì€ 'menu_categories'ë¥¼ ìˆœíšŒí•©ë‹ˆë‹¤.
            ì´ ë£¨í”„ ë•ë¶„ì— ë©”ë‰´ê°€ ìë™ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¬¶ì´ê²Œ ë©ë‹ˆë‹¤.
        {% endcomment %}
        {% for category in menu_categories %}
            <h4 class="mt-4 border-bottom pb-2">{{ category.name }}</h4>
            <div class="list-group list-group-flush">

                {% comment %} ë‘ ë²ˆì§¸ ë£¨í”„: ê° ì¹´í…Œê³ ë¦¬ì— ì†í•œ ë©”ë‰´ë“¤ì„ ìˆœíšŒí•©ë‹ˆë‹¤. {% endcomment %}
                {% for menu in category.menus.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            {% if menu.image %}
                                <img src="{{ menu.image.url }}" alt="{{ menu.name }}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-right: 15px; float: left;">
                            {% endif %}
                            <h5 class="mb-1">{{ menu.name }}</h5>
                            <p class="mb-1 text-muted">{{ menu.description }}</p>
                            <strong>{{ menu.price }}ì›</strong>
                        </div>

                        <button class="btn btn-outline-primary add-to-cart-btn"
                                data-menu-id="{{ menu.id }}"
                                data-menu-name="{{ menu.name }}"
                                data-menu-price="{{ menu.price }}">
                            ë‹´ê¸°
                        </button>
                    </div>
                {% endfor %}

            </div>
        {% empty %}
             <p class="text-center text-muted mt-4">ì‚¬ì¥ë‹˜ì´ ë©”ë‰´ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
        {% endfor %}

    </div>
</div>
<hr>


{% comment %} ... ì´ì „ ì½”ë“œ (ì‹ë‹¹ ì •ë³´, ë©”ë‰´ ë“±) ... {% endcomment %}
<div class="container mt-4">
    <h3>â­ ë°©ë¬¸ì ë¦¬ë·° ({{ restaurant.review_count }})</h3>
    <div class="d-flex align-items-center mb-3">
        <span class="badge bg-primary me-2">â­ {{ restaurant.rating|floatformat:1 }}</span>
    </div>

    <p class="lead">{{ restaurant.notice }}</p>
    <hr>
    
    {% comment %} ë¦¬ë·° ëª©ë¡ ë³´ì—¬ì£¼ê¸° {% endcomment %}
    <div class="list-group mt-3">
        {% for review in reviews %}
            <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ review.user.username }}</h5>
                    <small>ë³„ì : {{ review.rating }} / 5.0</small>
                </div>
                <p class="mb-1">{{ review.content }}</p>
                {% if review.image %}
                    <img src="{{ review.image.url }}" alt="ë¦¬ë·° ì‚¬ì§„" class="img-fluid rounded mt-2" style="max-height: 200px;">
                {% endif %}
                <small class="text-muted">{{ review.created_at|date:"Yë…„ mì›” dì¼" }}</small>
                
                {% comment %} ì‚¬ì¥ë‹˜ ëŒ“ê¸€ ë³´ì—¬ì£¼ê¸° {% endcomment %}
                {% if review.comment %}
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>ì‚¬ì¥ë‹˜ ëŒ“ê¸€</h6>
                    <p class="mb-0">{{ review.comment.content }}</p>
                    <small class="text-muted">{{ review.comment.created_at|date:"Yë…„ mì›” dì¼" }}</small>
                </div>
                {% endif %}
            </div>
        {% empty %}
            <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
        {% endfor %}
    </div>

    <hr class="my-4">

    {% comment %} ë¦¬ë·° ì‘ì„± í¼ {% endcomment %}
    <h4>ë¦¬ë·° ë‚¨ê¸°ê¸°</h4>
    
    {% if user.is_authenticated %}
        <form action="{% url 'restaurants:review_create' restaurant.pk %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-3">
                <label for="id_rating" class="form-label">ë³„ì </label>
                {{ review_form.rating }}
            </div>
            <div class="mb-3">
                <label for="id_content" class="form-label">ë‚´ìš©</label>
                {{ review_form.content }}
            </div>
            <div class="mb-3">
                <label for="id_image" class="form-label">ì‚¬ì§„ ì²¨ë¶€</label>
                {{ review_form.image }}
            </div>
            
            <button type="submit" class="btn btn-primary">ë¦¬ë·° ë“±ë¡</button>
        </form>
    {% else %}
        <p><a href="{% url 'accounts:login' %}?next={{ request.path }}">ë¡œê·¸ì¸</a> í›„ ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% endif %}

</div>

<hr>

{% comment %} ì¥ë°”êµ¬ë‹ˆì™€ ì£¼ë¬¸ ë²„íŠ¼ì´ í‘œì‹œë  ì˜ì—­ {% endcomment %}
<div class="cart-section mt-5 p-3 border rounded">
    <h3>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-items">
        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="text-end mt-3">
        <h4>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <span id="total-price">0</span>ì›</h4>
        <button id="order-btn" class="btn btn-success btn-lg">ì£¼ë¬¸í•˜ê¸°</button>
    </div>
</div>
<script>
    // 1. ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ì™€ í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
    const cart = {}; // ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´
    const menuList = document.querySelector('.menu-list');
    const cartItemsContainer = document.querySelector('#cart-items');
    const totalPriceEl = document.querySelector('#total-price');
    const orderBtn = document.querySelector('#order-btn');

    // 2. ë©”ë‰´ 'ë‹´ê¸°' ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
    menuList.addEventListener('click', function(event) {
        // í´ë¦­ëœ ìš”ì†Œê°€ 'ë‹´ê¸°' ë²„íŠ¼('.add-to-cart-btn')ì´ ì•„ë‹ˆë©´ í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        if (!event.target.classList.contains('add-to-cart-btn')) {
            return;
        }

        const btn = event.target;
        const menuId = btn.dataset.menuId;
        const menuName = btn.dataset.menuName;
        const menuPrice = parseInt(btn.dataset.menuPrice);

        // ì¥ë°”êµ¬ë‹ˆ(cart) ê°ì²´ì— ë©”ë‰´ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (cart[menuId]) {
            // ì´ë¯¸ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ 1 ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
            cart[menuId].quantity += 1;
        } else {
            // ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ë©”ë‰´ ì •ë³´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            cart[menuId] = {
                name: menuName,
                price: menuPrice,
                quantity: 1,
            };
        }

        // ì¥ë°”êµ¬ë‹ˆ UIë¥¼ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        updateCartUI();
    });

    // 3. ì¥ë°”êµ¬ë‹ˆ í™”ë©´(UI)ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateCartUI() {
        cartItemsContainer.innerHTML = ''; // ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        let totalPrice = 0;

        // ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (Object.keys(cart).length === 0) {
            cartItemsContainer.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
            totalPriceEl.textContent = 0;
            return; // í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
        }

        // ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ê° ë©”ë‰´ì— ëŒ€í•´ HTMLì„ ìƒì„±í•˜ê³  ì´ì•¡ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
        for (const menuId in cart) {
            const item = cart[menuId];
            totalPrice += item.price * item.quantity;

            // ê° ë©”ë‰´ ì•„ì´í…œì„ í‘œì‹œí•  HTML ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            const itemEl = document.createElement('div');
            itemEl.classList.add('d-flex', 'justify-content-between', 'my-2');
            itemEl.innerHTML = `
                <span>${item.name} x ${item.quantity}</span>
                <span>${(item.price * item.quantity).toLocaleString()}ì›</span>
            `;
            cartItemsContainer.appendChild(itemEl); // ìƒì„±ëœ ìš”ì†Œë¥¼ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.
        }

        // ê³„ì‚°ëœ ì´ ì£¼ë¬¸ ê¸ˆì•¡ì„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
        totalPriceEl.textContent = totalPrice.toLocaleString();
    }

    // 4. 'ì£¼ë¬¸í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤.
    orderBtn.addEventListener('click', function() {
        if (Object.keys(cart).length === 0) {
            alert('ì¥ë°”êµ¬ë‹ˆì— ë©”ë‰´ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”!');
            return;
        }

        // ë°±ì—”ë“œë¡œ ì „ì†¡í•  ë°ì´í„° í˜•ì‹ì„ ë§Œë“­ë‹ˆë‹¤.
        const cartItemsForBackend = Object.keys(cart).map(menuId => {
            return {
                menu_id: menuId,
                quantity: cart[menuId].quantity,
                options: {} // (ì˜µì…˜ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„)
            };
        });

        const dataToSend = {
            restaurant_pk: "{{ restaurant.pk }}",
            cart_items: cartItemsForBackend,
        };

        // CSRF í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // fetch APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
        fetch("{% url 'restaurants:order_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest', // AJAX ìš”ì²­ì„ì„ ëª…ì‹œ
            },
            body: JSON.stringify(dataToSend)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = data.redirect_url; // ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
            } else {
                alert('ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    });
</script>
</body>