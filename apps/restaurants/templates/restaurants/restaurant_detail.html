<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>{{ restaurant.name }} ë¦¬ë·°</title>
</head>
<body>
<hr>
{% comment %} ... ì´ì „ ì½”ë“œ (ì‹ë‹¹ ì •ë³´, ë©”ë‰´ ë“±) ... {% endcomment %}
<div class="container mt-4">
    <h3>â­ ë°©ë¬¸ì ë¦¬ë·° ({{ restaurant.review_count }})</h3>
    <div class="d-flex align-items-center mb-3">
        <span class="badge bg-primary me-2">â­ {{ restaurant.rating|floatformat:1 }}</span>
    </div>

    <p class="lead">{{ restaurant.notice }}</p>
    <hr>
    
    {% comment %} ë¦¬ë·° ëª©ë¡ ë³´ì—¬ì£¼ê¸° {% endcomment %}
    <div class="list-group mt-3">
        {% for review in reviews %}
            <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ review.user.username }}</h5>
                    <small>ë³„ì : {{ review.rating }} / 5.0</small>
                </div>
                <p class="mb-1">{{ review.content }}</p>
                {% if review.image %}
                    <img src="{{ review.image.url }}" alt="ë¦¬ë·° ì‚¬ì§„" class="img-fluid rounded mt-2" style="max-height: 200px;">
                {% endif %}
                <small class="text-muted">{{ review.created_at|date:"Yë…„ mì›” dì¼" }}</small>
                
                {% comment %} ì‚¬ì¥ë‹˜ ëŒ“ê¸€ ë³´ì—¬ì£¼ê¸° {% endcomment %}
                {% if review.comment %}
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>ì‚¬ì¥ë‹˜ ëŒ“ê¸€</h6>
                    <p class="mb-0">{{ review.comment.content }}</p>
                    <small class="text-muted">{{ review.comment.created_at|date:"Yë…„ mì›” dì¼" }}</small>
                </div>
                {% endif %}
            </div>
        {% empty %}
            <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
        {% endfor %}
    </div>

    <hr class="my-4">

    {% comment %} ë¦¬ë·° ì‘ì„± í¼ {% endcomment %}
    <h4>ë¦¬ë·° ë‚¨ê¸°ê¸°</h4>
    
    {% if user.is_authenticated %}
        <form action="{% url 'restaurants:review_create' restaurant.pk %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-3">
                <label for="id_rating" class="form-label">ë³„ì </label>
                {{ review_form.rating }}
            </div>
            <div class="mb-3">
                <label for="id_content" class="form-label">ë‚´ìš©</label>
                {{ review_form.content }}
            </div>
            <div class="mb-3">
                <label for="id_image" class="form-label">ì‚¬ì§„ ì²¨ë¶€</label>
                {{ review_form.image }}
            </div>
            
            <button type="submit" class="btn btn-primary">ë¦¬ë·° ë“±ë¡</button>
        </form>
    {% else %}
        <p><a href="{% url 'accounts:login' %}?next={{ request.path }}">ë¡œê·¸ì¸</a> í›„ ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% endif %}

</div>

{% comment %} ... ì´í›„ ì½”ë“œ ... {% endcomment %}
{% comment %} ë©”ë‰´ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ë¶€ë¶„ (ê¸°ì¡´ ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •) {% endcomment %}
<div class="menu-list">
    {% for category in restaurant.menu_categories.all %}
        <h4 class="mt-4">{{ category.name }}</h4>
        <div class="list-group">
            {% for menu in category.menus.all %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ menu.name }}</strong>
                        <p class="mb-1 text-muted">{{ menu.description }}</p>
                        <small>{{ menu.price }}ì›</small>
                    </div>
                    <button class="btn btn-outline-primary add-to-cart-btn" 
                            data-menu-id="{{ menu.id }}"
                            data-menu-name="{{ menu.name }}"
                            data-menu-price="{{ menu.price }}">
                        ë‹´ê¸°
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endfor %}
</div>

<hr>

{% comment %} ì¥ë°”êµ¬ë‹ˆì™€ ì£¼ë¬¸ ë²„íŠ¼ì´ í‘œì‹œë  ì˜ì—­ {% endcomment %}
<div class="cart-section mt-5 p-3 border rounded">
    <h3>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-items">
        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="text-end mt-3">
        <h4>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <span id="total-price">0</span>ì›</h4>
        <button id="order-btn" class="btn btn-success btn-lg">ì£¼ë¬¸í•˜ê¸°</button>
    </div>
</div>
<script>
    // 1. ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ì™€ í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ë³€ìˆ˜ì— ì €ì¥
    const cart = {}; // ì¥ë°”êµ¬ë‹ˆ ê°ì²´. ì˜ˆ: { "ë©”ë‰´ID": { name, price, quantity }, ... }
    
    const menuList = document.querySelector('.menu-list');
    const cartItemsContainer = document.querySelector('#cart-items');
    const totalPriceEl = document.querySelector('#total-price');
    const orderBtn = document.querySelector('#order-btn');

    // 2. ë©”ë‰´ 'ë‹´ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    menuList.addEventListener('click', function(event) {
        // í´ë¦­ëœ ìš”ì†Œê°€ 'ë‹´ê¸°' ë²„íŠ¼ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
        if (!event.target.classList.contains('add-to-cart-btn')) {
            return;
        }

        const btn = event.target;
        const menuId = btn.dataset.menuId;
        const menuName = btn.dataset.menuName;
        const menuPrice = parseInt(btn.dataset.menuPrice);

        // ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ìˆëŠ” ë©”ë‰´ì¸ì§€ í™•ì¸
        if (cart[menuId]) {
            cart[menuId].quantity += 1; // ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ 1 ì¦ê°€
        } else {
            // ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
            cart[menuId] = {
                name: menuName,
                price: menuPrice,
                quantity: 1,
            };
        }
        
        console.log('ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ:', cart);
        updateCartUI(); // ì¥ë°”êµ¬ë‹ˆ í™”ë©´ ì—…ë°ì´íŠ¸
    });

    // 3. ì¥ë°”êµ¬ë‹ˆ í™”ë©´(UI)ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateCartUI() {
        cartItemsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš©ì„ ë¹„ì›€
        let totalPrice = 0;

        // ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if (Object.keys(cart).length === 0) {
            cartItemsContainer.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
            totalPriceEl.textContent = 0;
            return;
        }

        for (const menuId in cart) {
            const item = cart[menuId];
            totalPrice += item.price * item.quantity;
            
            // ê° ë©”ë‰´ ì•„ì´í…œì„ í‘œì‹œí•  HTML ìƒì„±
            const itemEl = document.createElement('div');
            itemEl.classList.add('d-flex', 'justify-content-between', 'my-2');
            itemEl.innerHTML = `
                <span>${item.name} x ${item.quantity}</span>
                <span>${(item.price * item.quantity).toLocaleString()}ì›</span>
            `;
            cartItemsContainer.appendChild(itemEl);
        }

        totalPriceEl.textContent = totalPrice.toLocaleString();
    }
    
    // 4. 'ì£¼ë¬¸í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë°±ì—”ë“œì™€ í†µì‹ )
    orderBtn.addEventListener('click', function() {
        if (Object.keys(cart).length === 0) {
            alert('ì¥ë°”êµ¬ë‹ˆì— ë©”ë‰´ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”!');
            return;
        }

        // ë°±ì—”ë“œ(OrderCreateView)ê°€ ê¸°ëŒ€í•˜ëŠ” ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const cartItemsForBackend = Object.keys(cart).map(menuId => {
            return {
                menu_id: menuId,
                quantity: cart[menuId].quantity,
                options: {} // (ì˜µì…˜ ê¸°ëŠ¥ì€ ì—¬ê¸°ì„œ ì¶”ê°€ êµ¬í˜„ í•„ìš”)
            };
        });

        const dataToSend = {
            restaurant_pk: "{{ restaurant.pk }}",
            cart_items: cartItemsForBackend,
        };
        
        // Djangoì˜ CSRF ë³´í˜¸ ê¸°ëŠ¥ì„ í†µê³¼í•˜ê¸° ìœ„í•´ í† í°ì„ í—¤ë”ì— ì¶”ê°€
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // fetch APIë¥¼ ì‚¬ìš©í•´ ë°±ì—”ë“œë¡œ ë°ì´í„° ì „ì†¡
        fetch("{% url 'restaurants:order_create' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest', // AJAX ìš”ì²­ì„ì„ ëª…ì‹œ
            },
            body: JSON.stringify(dataToSend)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                // ë°±ì—”ë“œê°€ ì•Œë ¤ì¤€ ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = data.redirect_url;
            } else {
                alert('ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    });
</script>
</body>